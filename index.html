<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Configurateur LULY</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer@1.12.0/dist/model-viewer.min.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f5f5f5; 
      color: #333; 
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    #configurator { 
      display: flex; 
      flex-direction: column;
      max-width: 1200px; 
      margin: auto; 
      padding: 1rem; 
    }
    @media (min-width: 768px) {
      #configurator {
        flex-direction: row;
        gap: 2rem;
        padding: 2rem;
      }
    }
    .viewer { 
      flex: 2; 
      margin-bottom: 2rem;
    }
    model-viewer { 
      width: 100%; 
      height: 500px; 
      background: #fff; 
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: block;
    }
    #features { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      gap: 1rem; 
    }
    .group { 
      background: #fff; 
      border-radius: 8px; 
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .group h4 { 
      margin: 0 0 1rem; 
      padding-bottom: .5rem;
      border-bottom: 1px solid #eee;
      color: #2c3e50;
    }
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
    }
    .group button {
      flex: 1 0 120px;
      min-width: 120px;
      margin: .25rem 0; 
      padding: .75rem;
      border: 2px solid #eee; 
      border-radius: 6px; 
      background: #fafafa;
      cursor: pointer; 
      font-weight: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all .2s ease;
    }
    .group button:hover {
      border-color: #ddd;
      background: #f0f0f0;
    }
    .group button.selected { 
      border-color: #3377ff;
      background: #f0f7ff;
    }
    .color-preview {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-bottom: .5rem;
      border: 1px solid #ddd;
    }
    .price-tag {
      margin-top: .5rem;
      font-size: .8rem;
      color: #666;
    }
    #price-container {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #price { 
      font-size: 1.5rem; 
      font-weight: bold;
      color: #2c3e50;
      text-align: right;
    }
    footer {
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      font-size: .9rem;
      color: #666;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 500px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3377ff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <header>
    <h1>Configurateur LULY</h1>
  </header>

  <div id="configurator">
    <div class="viewer">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="margin-top:1rem; color:#666;">Chargement du modèle 3D…</p>
      </div>

      <!-- Votre model-viewer avec TRADIHOME4.glb -->
      <model-viewer
        id="model"
        src="TRADIHOME4.glb"
        alt="Modèle 3D de maison LULY"
        camera-controls
        auto-rotate
        shadow-intensity="1"
        environment-image="neutral"
        exposure="0.8"
        camera-orbit="-30deg 75deg 4m"
        style="display:none;">
      </model-viewer>
    </div>

    <div id="features">
      <!-- Bardage -->
      <div class="group" data-cat="bardage">
        <h4>Bardage extérieur</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="0">
            <div class="color-preview" style="background:#fff"></div>Blanc
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#8c6a4f" data-cost="799">
            <div class="color-preview" style="background:#8c6a4f"></div>Chêne foncé
            <span class="price-tag">+799 €</span>
          </button>
          <button data-color="#343a40" data-cost="899">
            <div class="color-preview" style="background:#343a40"></div>Gris orage
            <span class="price-tag">+899 €</span>
          </button>
        </div>
      </div>

      <!-- Menuiserie -->
      <div class="group" data-cat="menuiserie">
        <h4>Menuiserie alu</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="0">
            <div class="color-preview" style="background:#fff"></div>Blanc
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#2e2e2e" data-cost="2499">
            <div class="color-preview" style="background:#2e2e2e"></div>Anthracite
            <span class="price-tag">+2499 €</span>
          </button>
        </div>
      </div>

      <!-- Murs -->
      <div class="group" data-cat="murs">
        <h4>Peinture murs</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="0">
            <div class="color-preview" style="background:#fff"></div>Blanc
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#d6c9b1" data-cost="999">
            <div class="color-preview" style="background:#d6c9b1"></div>Beige Ares
            <span class="price-tag">+999 €</span>
          </button>
          <button data-color="#e5b79c" data-cost="1499">
            <div class="color-preview" style="background:#e5b79c"></div>Ocre Mojave
            <span class="price-tag">+1499 €</span>
          </button>
        </div>
      </div>

      <!-- Pergola -->
      <div class="group" data-cat="pergola">
        <h4>Pergola bioclimatique</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="8500">
            <div class="color-preview" style="background:#fff"></div>Blanc
            <span class="price-tag">+8500 €</span>
          </button>
          <button data-color="#2e2e2e" data-cost="9500">
            <div class="color-preview" style="background:#2e2e2e"></div>Anthracite
            <span class="price-tag">+9500 €</span>
          </button>
        </div>
      </div>

      <!-- Toiture -->
      <div class="group" data-cat="toiture">
        <h4>Toiture tôle</h4>
        <div class="options">
          <button data-color="#243241" data-cost="0">
            <div class="color-preview" style="background:#243241"></div>Bleu ardoise
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#b0b0b0" data-cost="0">
            <div class="color-preview" style="background:#b0b0b0"></div>Gris acier
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#c0392b" data-cost="1800">
            <div class="color-preview" style="background:#c0392b"></div>Rouge hibiscus
            <span class="price-tag">+1800 €</span>
          </button>
        </div>
      </div>

      <div id="price-container">
        <p id="price">Prix total : 170 000 €</p>
      </div>
    </div>
  </div>

  <footer>
    <p>© 2025 LULY – Configurateur de maisons • Tous droits réservés</p>
  </footer>

  <script type="module">
    const basePrice = 170000;
    const viewer   = document.getElementById('model');
    const loading  = document.getElementById('loading');
    const priceEl  = document.getElementById('price');
    const selection = {};
    // mapping par mot-clé (minuscule)
    const materialMapping = {
      bardage:    ['poutrine01','poutrine02'],
      menuiserie: ['porte','cadre','volet','fenetre'],
      murs:       ['mur'],
      pergola:    ['pergola','poutres'],
      toiture:    ['toit']
    };

    function hexToRGBA(hex) {
      const v = parseInt(hex.slice(1),16);
      return [(v>>16&255)/255,(v>>8&255)/255,(v&255)/255,1];
    }

    function applyColor(materials, cat, rgba) {
      let applied=false;
      materials.forEach(mat => {
        const name=mat.name.toLowerCase();
        if (materialMapping[cat].some(k=>name.includes(k))) {
          mat.pbrMetallicRoughness.setBaseColorFactor(rgba);
          applied=true;
        }
      });
      return applied;
    }

    viewer.addEventListener('load', ()=>{
      // afficher le viewer, cacher le loader
      loading.style.display='none';
      viewer.style.display='block';

      // liste debug
      console.log('Matériaux:', viewer.model.materials.map(m=>m.name));

      // attacher partout
      document.querySelectorAll('.group').forEach(group=>{
        const cat=group.dataset.cat;
        const materials=viewer.model.materials;
        group.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click',()=>{
            // UI
            group.querySelectorAll('button')
                 .forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            // prix
            selection[cat]=+btn.dataset.cost;
            const total=Object.values(selection).reduce((a,b)=>a+b,basePrice);
            priceEl.textContent=`Prix total : ${total.toLocaleString()} €`;
            // couleur
            const rgba=hexToRGBA(btn.dataset.color);
            const ok=applyColor(materials,cat,rgba);
            if(!ok) console.warn(`Aucun matériau recoloré pour ${cat}`);
          });
        });
        // click par défaut
        group.querySelector('button').click();
      });
    });

    viewer.addEventListener('error', e=>{
      console.error('Erreur modèle :',e);
      loading.innerHTML=`<p style="color:#e74c3c;font-weight:bold;">
        ❌ Impossible de charger TRADIHOME4.glb</p>
        <p>Vérifiez bien le nom et l’emplacement du fichier.</p>`;
    });
  </script>
</body>
</html>

