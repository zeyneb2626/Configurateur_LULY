<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Configurateur TRADIHOME P4</title>

  <!-- ModelViewer 1.12.0 -->
  <script type="module"
    src="https://unpkg.com/@google/model-viewer@1.12.0/dist/model-viewer.min.js">
  </script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0 }
    html, body { height:100%; font-family: sans-serif; }
    #container {
      display: flex;
      height: 100vh;
    }

    /********** VIEWER **********/
    model-viewer {
      flex: 3;
      width: 100%;
      height: 100%;
      background: #fff;

      /* boost textures */
      filter: contrast(1.3) saturate(1.2);

      /* qualité & ombres */
      environment-image="studio_small"
      exposure="0.6"
      shadow-intensity="1"
      shadow-softness="1.5"
      min-pixel-ratio="1"
      max-pixel-ratio="3"

      /* contrôle caméra */
      camera-controls
      auto-rotate

      loading="eager"
    }

    /********** CONTROLES **********/
    #controls {
      flex: 1;
      background: #f6f6f6;
      border-left: 1px solid #ddd;
      padding: 1rem;
      overflow-y: auto;
    }
    #controls h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #333;
    }
    .category {
      margin-bottom: 1.5rem;
    }
    .category h3 {
      margin-bottom: .5rem;
      font-size: 1rem;
      color: #2c3e50;
    }
    .swatches {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
    }
    .swatch {
      width: 40px;
      height: 40px;
      border: 2px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      transition: border .2s ease;
    }
    .swatch:hover {
      border-color: #888;
    }
    .swatch.selected {
      outline: 3px solid #007aff;
    }
    .swatch::after {
      content: attr(data-label);
      position: absolute;
      bottom: -1.3rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: .6rem;
      color: #333;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div id="container">
    <!--========= 3D VIEWER =========-->
    <model-viewer
      id="mv"
      src="TRADIHOME4.glb"
      alt="Maison TRADIHOME P4"
    ></model-viewer>

    <!--========= PANNEAU DE CONTROLES =========-->
    <div id="controls">
      <h2>Personnalisez votre maison</h2>

      <!-- 1. Bardage extérieur -->
      <div class="category" data-cat="Bardage">
        <h3>Bardage extérieur</h3>
        <div class="swatches">
          <button class="swatch" data-cat="Bardage" data-label="Chêne clair" data-color="#C19A6B"></button>
          <button class="swatch" data-cat="Bardage" data-label="Chêne foncé" data-color="#8B5A2B"></button>
          <button class="swatch" data-cat="Bardage" data-label="Gris oragé"  data-color="#3D4C5C"></button>
        </div>
      </div>

      <!-- 2. Menuiserie ALU -->
      <div class="category" data-cat="Menuiserie">
        <h3>Menuiserie alu</h3>
        <div class="swatches">
          <button class="swatch" data-cat="Menuiserie" data-label="Blanc"      data-color="#FFFFFF"></button>
          <button class="swatch" data-cat="Menuiserie" data-label="Anthracite" data-color="#293133"></button>
        </div>
      </div>

      <!-- 3. Gouttière et descente -->
      <div class="category" data-cat="Gouttiere">
        <h3>Gouttière &amp; descente</h3>
        <div class="swatches">
          <button class="swatch" data-cat="Gouttiere" data-label="Blanc" data-color="#FFFFFF"></button>
        </div>
      </div>

      <!-- 4. Pergola bioclimatique -->
      <div class="category" data-cat="Pergola">
        <h3>Pergola bioclimatique</h3>
        <div class="swatches">
          <button class="swatch" data-cat="Pergola" data-label="Blanc"      data-color="#FFFFFF"></button>
          <button class="swatch" data-cat="Pergola" data-label="Anthracite" data-color="#293133"></button>
        </div>
      </div>

      <!-- 5. Peinture (mur extérieur) -->
      <div class="category" data-cat="Murs">
        <h3>Peinture murs extérieurs</h3>
        <div class="swatches">
          <button class="swatch" data-cat="Murs" data-label="Blanc"         data-color="#FFFFFF"></button>
          <button class="swatch" data-cat="Murs" data-label="Beige Ares"    data-color="#CCC0AF"></button>
          <button class="swatch" data-cat="Murs" data-label="Ocre Mojave"   data-color="#E6C7B1"></button>
        </div>
      </div>

      <!-- 6. Tôle ondulée -->
      <div class="category" data-cat="Toit">
        <h3>Tôle ondulée</h3>
        <div class="swatches">
          <button class="swatch" data-cat="Toit" data-label="Bleu Ardoise"   data-color="#133654"></button>
          <button class="swatch" data-cat="Toit" data-label="Gris Acier"     data-color="#777777"></button>
          <button class="swatch" data-cat="Toit" data-label="Rouge Hibiscus" data-color="#CC3333"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const mv = document.getElementById('mv');

      // Fragments exacts à comparer (mise en minuscules)
      const targets = {
        Bardage:    ['poutrine01','poutrine02'],
        Menuiserie: ['porte','cadre porte fenetre','volets','encadrement'],
        Gouttiere:  ['goutieres'],
        Pergola:    ['poutres','volet pergola'],
        Murs:       ['murs'],
        Toit:       ['toit1','toit contour']
      };

      mv.addEventListener('load', async () => {
        const model = mv.model;
        if (!model) {
          console.error('❌ mv.model est undefined');
          return;
        }
        const materials = model.materials;
        console.log('--- Matériaux trouvés dans le GLB ---');
        materials.forEach(mat => console.log('•', mat.name));

        // Convertit un "#rrggbb" en [r,g,b,a]
        function hex2rgba(h) {
          const v = parseInt(h.slice(1), 16);
          return [
            ((v >> 16) & 255) / 255,
            ((v >> 8) & 255) / 255,
            (v & 255) / 255,
            1
          ];
        }

        // Pour chaque catégorie, branche le click
        document.querySelectorAll('.category').forEach(catDiv => {
          const cat = catDiv.dataset.cat;
          const frags = targets[cat] || [];

          catDiv.querySelectorAll('.swatch').forEach(btn => {
            btn.addEventListener('click', () => {
              // UI : mettre à jour la sélection
              catDiv.querySelectorAll('.swatch')
                .forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');

              // Nouvelle couleur
              const rgba = hex2rgba(btn.dataset.color);

              // Applique à tous les matériaux dont le nom contient un fragment
              materials.forEach(mat => {
                const lname = mat.name.toLowerCase();
                if (frags.some(f => lname.includes(f))) {
                  mat.pbrMetallicRoughness.setBaseColorFactor(rgba);
                }
              });
            });
          });

          // Sélection par défaut du 1er swatch
          const first = catDiv.querySelector('.swatch');
          if (first) first.click();
        });
      });
    });
  </script>
</body>
</html>

