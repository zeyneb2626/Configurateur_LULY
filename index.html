<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Configurateur LULY</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f5f5f5; 
      color: #333; 
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    #configurator { 
      display: flex; 
      flex-direction: column;
      max-width: 1200px; 
      margin: auto; 
      padding: 1rem; 
    }
    @media (min-width: 768px) {
      #configurator {
        flex-direction: row;
        gap: 2rem;
        padding: 2rem;
      }
    }
    .viewer { 
      flex: 2; 
      margin-bottom: 2rem;
    }
    model-viewer { 
      width: 100%; 
      height: 500px; 
      background: #fff; 
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #features { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      gap: 1rem; 
    }
    .group { 
      background: #fff; 
      border-radius: 8px; 
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .group h4 { 
      margin: 0 0 1rem; 
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
      color: #2c3e50;
    }
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .group button {
      flex: 1 0 120px;
      min-width: 120px;
      margin: 0.25rem 0; 
      padding: 0.75rem;
      border: 2px solid #eee; 
      border-radius: 6px; 
      background: #fafafa;
      cursor: pointer; 
      font-weight: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.2s ease;
    }
    .group button:hover {
      border-color: #ddd;
      background: #f0f0f0;
    }
    .group button.selected { 
      border-color: #3377ff;
      background: #f0f7ff;
    }
    .color-preview {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-bottom: 0.5rem;
      border: 1px solid #ddd;
    }
    .price-tag {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #666;
    }
    #price-container {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #price { 
      font-size: 1.5rem; 
      font-weight: bold;
      color: #2c3e50;
      text-align: right;
    }
    footer {
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #666;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 500px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3377ff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <h1>Configurateur LULY</h1>
  </header>

  <div id="configurator">
    <div class="viewer">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: #666;">Chargement du modèle 3D...</p>
      </div>
      <model-viewer
        id="model"
        src="https://models.babylonjs.com/Duck.glb"
        alt="Modèle 3D test - Canard"
        camera-controls
        auto-rotate
        shadow-intensity="1"
        environment-image="neutral"
        exposure="0.8"
        camera-orbit="-30deg 75deg 4m"
        style="display: none;"
      ></model-viewer>
    </div>
    <div id="features">
      <div class="group" data-cat="bardage">
        <h4>Bardage extérieur</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="0">
            <div class="color-preview" style="background-color: #ffffff;"></div>
            Blanc
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#8c6a4f" data-cost="799">
            <div class="color-preview" style="background-color: #8c6a4f;"></div>
            Chêne foncé
            <span class="price-tag">+799 €</span>
          </button>
          <button data-color="#343a40" data-cost="899">
            <div class="color-preview" style="background-color: #343a40;"></div>
            Gris orage
            <span class="price-tag">+899 €</span>
          </button>
        </div>
      </div>
      <div class="group" data-cat="menuiserie">
        <h4>Menuiserie alu</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="0">
            <div class="color-preview" style="background-color: #ffffff;"></div>
            Blanc
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#2e2e2e" data-cost="2499">
            <div class="color-preview" style="background-color: #2e2e2e;"></div>
            Anthracite
            <span class="price-tag">+2499 €</span>
          </button>
        </div>
      </div>
      <div class="group" data-cat="murs">
        <h4>Peinture murs</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="0">
            <div class="color-preview" style="background-color: #ffffff;"></div>
            Blanc
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#d6c9b1" data-cost="999">
            <div class="color-preview" style="background-color: #d6c9b1;"></div>
            Beige Ares
            <span class="price-tag">+999 €</span>
          </button>
          <button data-color="#e5b79c" data-cost="1499">
            <div class="color-preview" style="background-color: #e5b79c;"></div>
            Ocre Mojave
            <span class="price-tag">+1499 €</span>
          </button>
        </div>
      </div>
      <div class="group" data-cat="pergola">
        <h4>Pergola bioclimatique</h4>
        <div class="options">
          <button data-color="#ffffff" data-cost="8500">
            <div class="color-preview" style="background-color: #ffffff;"></div>
            Blanc
            <span class="price-tag">+8500 €</span>
          </button>
          <button data-color="#2e2e2e" data-cost="9500">
            <div class="color-preview" style="background-color: #2e2e2e;"></div>
            Anthracite
            <span class="price-tag">+9500 €</span>
          </button>
        </div>
      </div>
      <div class="group" data-cat="toiture">
        <h4>Toiture tôle</h4>
        <div class="options">
          <button data-color="#243241" data-cost="0">
            <div class="color-preview" style="background-color: #243241;"></div>
            Bleu ardoise
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#b0b0b0" data-cost="0">
            <div class="color-preview" style="background-color: #b0b0b0;"></div>
            Gris acier
            <span class="price-tag">inclus</span>
          </button>
          <button data-color="#c0392b" data-cost="1800">
            <div class="color-preview" style="background-color: #c0392b;"></div>
            Rouge hibiscus
            <span class="price-tag">+1800 €</span>
          </button>
        </div>
      </div>
      <div id="price-container">
        <p id="price">Prix total : 170 000 €</p>
      </div>
    </div>
  </div>

  <footer>
    <p>© 2025 LULY - Configurateur de maisons • Tous droits réservés</p>
  </footer>

  <script type="module">
    const basePrice = 170000;
    const modelViewer = document.getElementById('model');
    const priceEl = document.getElementById('price');
    const loadingEl = document.getElementById('loading');

    // Mapping des matériaux selon les noms usuels dans le modèle test
    // Ces noms seront comparés de manière insensible à la casse pour plus de flexibilité
    const materialMapping = {
      // Bardage extérieur (corps du canard dans le modèle de test)
      bardage: ['duck'],
      
      // Menuiserie alu (yeux/bec du canard dans le modèle de test)
      menuiserie: ['bec', 'yeux'],
      
      // Utilisation de tous les matériaux disponibles pour test
      murs: ['all'],
      pergola: ['all'],
      toiture: ['all']
    };

    function hexToRGBA(hex) {
      const v = parseInt(hex.slice(1), 16);
      return [(v>>16&255)/255, (v>>8&255)/255, (v&255)/255, 1];
    }

    const selection = {};
    
    // Fonction pour rechercher un matériau par son nom exact
    function findMaterialByName(materials, targetName) {
      return materials.find(mat => mat.name === targetName);
    }
    
    // Fonction pour vérifier si un matériau appartient à une catégorie
    function isMaterialInCategory(materialName, categoryNames) {
      if (categoryNames.includes('all')) return true;
      
      const lowerMaterialName = materialName.toLowerCase();
      return categoryNames.some(targetName => 
        lowerMaterialName.includes(targetName.toLowerCase())
      );
    }

    // Fonction pour appliquer une couleur à un matériau
    function applyColorToMaterial(material, color) {
      try {
        if (material && material.pbrMetallicRoughness) {
          material.pbrMetallicRoughness.setBaseColorFactor(color);
          return true;
        }
      } catch (error) {
        console.error(`Erreur lors de l'application de la couleur:`, error);
      }
      return false;
    }

    modelViewer.addEventListener('load', () => {
      console.log('Modèle 3D chargé avec succès');
      
      // Cacher le chargement et afficher le modèle
      loadingEl.style.display = 'none';
      modelViewer.style.display = 'block';
      
      const materials = modelViewer.model.materials;
      
      // Afficher les noms des matériaux disponibles pour le débogage
      console.log('Matériaux disponibles dans le modèle:');
      materials.forEach(mat => console.log(`${mat.name}`));
      
      // Mécanisme de debug avancé pour afficher plus d'informations sur les matériaux
      console.log('Détails des matériaux:');
      materials.forEach((mat, index) => {
        console.log(`Matériau #${index}: ${mat.name}`);
        console.log('- Base Color:', mat.pbrMetallicRoughness?.baseColorFactor);
        console.log('- Roughness:', mat.pbrMetallicRoughness?.roughnessFactor);
        console.log('- Metallic:', mat.pbrMetallicRoughness?.metallicFactor);
      });
      
      document.querySelectorAll('.group').forEach(group => {
        const category = group.dataset.cat;
        const materialTargets = materialMapping[category] || [];
        
        group.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => {
            // Mise à jour visuelle
            group.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            // Mise à jour du prix
            selection[category] = Number(btn.dataset.cost);
            const total = Object.values(selection).reduce((a, b) => a + b, basePrice);
            priceEl.textContent = `Prix total : ${total.toLocaleString()} €`;
            
            // Application de la couleur
            const rgba = hexToRGBA(btn.dataset.color);
            let applied = false;
            
            // Modification de tous les matériaux qui correspondent à cette catégorie
            materials.forEach(material => {
              const materialName = material.name;
              
              // Test de correspondance avec insensibilité à la casse
              const matches = isMaterialInCategory(materialName, materialTargets);
              
              if (matches) {
                console.log(`Changement de couleur pour ${material.name} (catégorie: ${category})`);
                // Modifier uniquement le facteur de couleur de base (baseColorFactor)
                const success = applyColorToMaterial(material, rgba);
                if (success) {
                  applied = true;
                }
              }
            });
            
            if (!applied && category !== 'toiture' && category !== 'pergola') {
              console.warn(`Aucun matériau trouvé pour la catégorie: ${category}`);
              console.warn(`Noms recherchés: ${materialTargets.join(', ')}`);
              
              // Pour le modèle de test, utilisons le premier matériau disponible
              if (materials.length > 0) {
                console.log(`Application sur le premier matériau disponible pour la démo`);
                applyColorToMaterial(materials[0], rgba);
              }
            }
          });
        });
        
        // Sélectionner la première option par défaut pour chaque groupe
        group.querySelector('button').click();
      });
    });
    
    // Gestion des erreurs de chargement
    modelViewer.addEventListener('error', (error) => {
      console.error('Erreur de chargement du modèle:', error);
      loadingEl.innerHTML = `
        <div style="text-align: center;">
          <p style="color: #e74c3c; font-weight: bold;">Erreur de chargement du modèle 3D</p>
          <p>Utilisation du modèle 3D de test...</p>
          
          <div style="margin-top: 2rem; border: 1px solid #ddd; padding: 1rem; border-radius: 8px; max-width: 600px; margin: 1rem auto; text-align: left;">
            <h3>Pourquoi nous utilisons un modèle de test</h3>
            <p>Nous avons détecté des problèmes avec le chargement de votre fichier GLB. GitHub a des limitations pour les fichiers volumineux :</p>
            <ul>
              <li>GitHub limite les fichiers à 100 Mo sans Git LFS</li>
              <li>GitHub Pages peut avoir des difficultés à servir des fichiers binaires volumineux</li>
              <li>Les chemins d'accès et les délais de déploiement peuvent causer des erreurs</li>
            </ul>
            
            <h4>Solutions recommandées :</h4>
            <ol>
              <li>Utiliser Git LFS pour gérer votre fichier GLB (voir <a href="https://git-lfs.github.com/" target="_blank">git-lfs.github.com</a>)</li>
              <li>Héberger votre modèle 3D sur un service dédié comme Sketchfab ou Poly Haven</li>
              <li>Réduire la taille de votre modèle 3D (compression, optimisation)</li>
              <li>Utiliser un CDN comme jsDelivr pour accéder aux fichiers GitHub : <code>https://cdn.jsdelivr.net/gh/zeyneb2626/Configurateur_LULY@main/model4.glb</code></li>
            </ol>
          </div>
          
          <button id="troubleshoot" style="padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">Essayer d'autres options</button>
        </div>
      `;
      
      // Ajouter un gestionnaire pour afficher plus d'options
      document.getElementById('troubleshoot')?.addEventListener('click', () => {
        loadingEl.innerHTML += `
          <div style="margin-top: 1rem; text-align: left; background: #f0f0f0; padding: 1rem; border-radius: 4px; max-width: 600px; margin: 1rem auto;">
            <h4>Autres URLs à essayer :</h4>
            <ul style="text-align: left;">
              <li><button class="try-url" data-url="https://cdn.jsdelivr.net/gh/zeyneb2626/Configurateur_LULY@main/model4.glb" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer;">CDN jsDelivr</button></li>
              <li><button class="try-url" data-url="https://raw.githubusercontent.com/zeyneb2626/Configurateur_LULY/main/model4.glb" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer;">GitHub Raw</button></li>
              <li><button class="try-url" data-url="./model4.glb" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer;">Chemin relatif local</button></li>
              <li><button class="try-url" data-url="https://models.babylonjs.com/Duck.glb" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer;">Modèle de test (Canard)</button></li>
            </ul>
          </div>
        `;
        
        // Ajouter des gestionnaires pour chaque URL à essayer
        document.querySelectorAll('.try-url').forEach(button => {
          button.addEventListener('click', () => {
            const url = button.dataset.url;
            console.log(`Essai avec l'URL: ${url}`);
            modelViewer.src = url;
          });
        });
      });
    });
  </script>
  </script>-width: 500px; margin: 1rem auto;">
                <p style="color: #e74c3c; font-weight: bold;">❌ Le fichier model4.glb n'a pas été trouvé!</p>
                <p>Erreur: ${error.message}</p>
                <p>Vérifiez que le fichier a bien été téléchargé sur GitHub avec le nom exact.</p>
              </div>
            `;
          });
      });
    });
  </script>
</body>
</html>
